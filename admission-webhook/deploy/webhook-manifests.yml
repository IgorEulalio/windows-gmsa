## Template to deploy the GMSA webhook
## TODO: make this a helmchart instead?

apiVersion: v1
kind: Namespace
metadata:
  name: gmsa-webhook
  labels:
    gmsa-webhook: disabled

---

apiVersion: v1
kind: Secret
metadata:
  name: gmsa-webhook
  namespace: gmsa-webhook
data:
  tls_private_key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBenJLK3lONzAwdmhQMnNxSlZ2RUZ2aE00SDB3UHZHTkI4R2JrbG52R2R0UWQ5ZlNMCkJIbEpnWjh0Ykhjdi9MajJDUmpoSkRISGp4UjJXSUpJay92dUErazhYTEVPSmV3RlgwSEpYcDVGNCt2cGFEMTgKaXpHR3M5VmF4dzNjZGlEUStkQXhXeDIrQ3MvcHA0bEdlTmQxYTR3MDJoOFpUYnRRMnlHNW44RTFIajRpYzEvTwoyTGs3Vy90eU9hdEE1M2J3Y1liUkliK2pUT0pnanFQR1JtMEs4V1AwTVZ4YThud2QwM3lkcmRHZHNEbzAwRXo1CkVRTTdyV3FmWEUwdjRWY2QzanFOS2ZjTHVkVWczNm5XcnRDRCtKYlgwUGZURzUrc0pTMUFxK0s0LzJBenlBOGoKQjFBOWU4eXJ5MDFwOERyK28vSUpwcWtLK0RCNkE4cHdvd3Y4TndJREFRQUJBb0lCQUJhZXNRcENmQUJxZERLNQpYM1pJUWh5ZTlkRlcvWkhjT3VjWUc0UHNYN2U1VnQ0SHVQN3dWdjc4Y0hnaVF2b2hNNnVqTVdCSW9sSWlKeUZnCmdKalJSU2JnYTE2cGNhYnN3Vm0vVlU0cGUvU0phSzJqclBGK3BnTWdJaU1PZlVYZ0tYNXRMam1PYzdHek54ckMKaHhmS1hHczhtTHdXRXlyU2lQS3lLaUkxZnA2a2M0ZHFGWi9WNzJTQmRueEMvd2dPMkgva2VPeTBwU2NkcnVqUgpEVlg3a1ZlVEIzTXBzTkpGb0xWckl0L1dTZkhmMnRybVNwUklrU29RUEt6elladUFaL0I0NTFRVEhWRjZmdVZICk1UeE5zbFNEVnFpYm52RTJhYUI4REZON1NjR3RBcW1JTk5LbHlja1FvUHU4MFF5cjgxNVcyWjFvVlhUQmV2N2UKKzBiUEQ4RUNnWUVBL0pBQlVJSEtqNTRCNkV6bUlvMGJiTmxOYVQyYnArYnVVYmR4Y25PVTAzTGNjVzVaQXNQbgpZNkd5QTRKWi9mNXJFbURDV0dQandkcnFiakFqN0FGckxvOGw0cFJFc1o4L1Z6MGk4L1RDZzBRTHJoclFIbTRCCjM2OEl2dFI0ZUsyMDJRRkxLVlBtWTYyQWQyaTZnNFFRRUlBSXg5aHdncFZUQTZWZ1dNSi9Xd2tDZ1lFQTBZTHYKemN4UHBQSEZ2eDZMNDlrVHJWU240dXhkbVFoNXhLWmVPZDlnYzFsQVRMYXhpSlc0dmw1OGZoUkx1ajdQRzhVRwpPRnRYaVNYNXZaK0YrcXR6VHN1eUE2U1o0eVlvSHdZY2JUMHBtNG80ejFYWGV4dnZYYlNlalpEbGtSaSt3cUN2Ck1FaGhSTWwvOWJGU24wUW5nSXhZVnUxclp1LzNtWHJCcnBZVUxUOENnWUF5WlRXdDc4Z1FjakhsUFhycVNBZkIKNTNaWDJwQTFwNUhFUW50am9BYUJUcmtIOVVIVG1HMlNadEJUZk80aURXTW1EcUtZNm8ybXY5enBVYmZKUHRzNQpOaDBVSWd1MitaUzAvcUQ3MXNuOVVWV1hUd2hhR2c5THAreHh6NG1lWXVMa0xpcm1PelNNalRGR0ltS2RIWHZyCkh2RWhsMkdUM09Ic3AxSWJRK3dQcVFLQmdRQ2dwUUJRMFdjRU4yb0QyRjAxRUw2WXVmK2M3Tlg3d0ZiMTVRYjgKNHYxbWxMbkwySTJhQ0F0RzFOWXFLay9DZCtTQUMzdHdmUUZLcFBhd1lmL3VLOFpYVmJLaVBuVE1pZlpiaTJrQwpqZEk0ZEN5Sk5lM3FkSW4rVkw3NkYyOGU2VlZqa0tlam91d0tQV0xETmZyL0tkZ01KaENhWHFOcW8zYzdsTGVyCnNXRzVLd0tCZ1FDSGNpZFpodS9uTlFqRlByQ0xXbWlLeEcvVmhOUGJkRVRFdG5pUSsyNWRqdHJSdGE0aFdzbXkKOWZIOUVhMkg2ZWtSRGg1N0hjS0xmK0kxUzdlSTBYa2NrSjhyQkNYRXFFYzI0VmdaVk4vdWhWMm96cWpsbm0xTQp5cXRON1ZoRUVjOGtYeGhnbFJuUndnRDZHSHhJVHBzS1J4alN4N3BVdklGb1NldFY3VnNXOGc9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=
  tls_certificate: TBD

---

# the service account for the webhook
apiVersion: v1
kind: ServiceAccount
metadata:
  name: gmsa-webhook
  namespace: gmsa-webhook

---

# the RBAC role that the webhook needs to:
#  * read GMSA custom resources
#  * check authorizations to use GMSA cred specs
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: gmsa-webhook-gmsa-webhook-rbac-role
rules:
- apiGroups: ["windows.k8s.io"]
  resources: ["gmsacredentialspecs"]
  verbs: ["get"]
- apiGroups: ["authorization.k8s.io"]
  resources: ["localsubjectaccessreviews"]
  verbs: ["create"]

---

# bind that role to the webhook's service account
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: gmsa-webhook-gmsa-webhook-binding-to-gmsa-webhook-gmsa-webhook-rbac-role
  namespace: gmsa-webhook
subjects:
- kind: ServiceAccount
  name: gmsa-webhook
  namespace: gmsa-webhook
roleRef:
  kind: ClusterRole
  name: gmsa-webhook-gmsa-webhook-rbac-role
  apiGroup: rbac.authorization.k8s.io

---

apiVersion: apps/v1
kind: Deployment
metadata:
  name: gmsa-webhook
  namespace: gmsa-webhook
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gmsa-webhook
  template:
    metadata:
      labels:
        app: gmsa-webhook
    spec:
      serviceAccountName: gmsa-webhook
      nodeSelector:
        beta.kubernetes.io/os: linux
      containers:
      - name: gmsa-webhook
        image: sigwindowstools/k8s-gmsa-webhook:latest
        imagePullPolicy: IfNotPresent
        readinessProbe:
          httpGet:
            scheme: HTTPS
            path: /health
            port: 443
        ports:
        - containerPort: 443
        volumeMounts:
          - name: tls
            mountPath: "/tls"
            readOnly: true
        env:
          - name: TLS_KEY
            value: /tls/key
          - name: TLS_CRT
            value: /tls/crt
      volumes:
      - name: tls
        secret:
          secretName: gmsa-webhook
          items:
          - key: tls_private_key
            path: key
          - key: tls_certificate
            path: crt

---

apiVersion: v1
kind: Service
metadata:
  name: gmsa-webhook
  namespace: gmsa-webhook
spec:
  ports:
  - port: 443
    targetPort: 443
  selector:
    app: gmsa-webhook

---

apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  name: gmsa-webhook
webhooks:
- name: admission-webhook.windows-gmsa.sigs.k8s.io
  clientConfig:
    service:
      name: gmsa-webhook
      namespace: gmsa-webhook
      path: "/validate"
    caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJeU1Ea3lPREUyTkRjek1Wb1hEVE15TURreU5URTJORGN6TVZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTjJRCm1pS1IrdCtBcFVFYkR2STNBRE1CdEVsa1d2ZFhxRjBhVnkxZk5IOVVaZEhJSEJXblNmNjJVS3F4aFNXdGdhWTIKTStNcVE5OWdKdXNReHhUTEFPYUczRHRmeUJDUGxqbmxVNmZtRHhJWCsvaElMRUJtNlBqcmVOM3FDQzZ4dVpFSgpCMDZSMkJ5d0NEV1I4dmx0YmZPWm8vcE5UcTFtVDYxWFdhQkRabFl4Zy8wcHZjUTV0Z3ZtZjd6SThpbUdGTFRZCkFDZnhKVnhqVDR6TUlKOU9SY2tDZmhXTVJ3YXlmWFZ5SUx6QVFld1Z4SW5yRWlhTWsybGdhN1REcDhvQjNjMGIKMlFyS2dBNG9PS1ltcjBHL0NvbmFOc2c0eFh0dkdodDIxUFcwQ3lweEEwWmtPR1VoaEROMnd2TUlWUytCNFgyTApucG9BL3dySlVLa2ExUnEvNjFNQ0F3RUFBYU5aTUZjd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZDajhncGtCRnpPTmtqMVZZNHQ5cDZUSWtOQk1NQlVHQTFVZEVRUU8KTUF5Q0NtdDFZbVZ5Ym1WMFpYTXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBTFdqMFlPd25OWndOb2Jxd3FvRgp5bkVNSjdFK2FYd0dEM0ljdW9FRTFEKzBVRWNFYmpjM1B4M0dEVU5vSnZhVTNYbTJOSktkVWgzaDQrcnFlQTlxCmNUL1QwbDRsSEJCaUZCNlBFZzhValQ1aW9YdUpnRHY2WXJjTStTTlhIbzE5Zm8wM0JET3JaQXVoaTFjRFlpS3oKcTk5Ri9Cam54R0V2S05obkhKM2xROHZuem5mNkEwYm91WGJ3bll1N0ZSRTVFc0VvZVZ5VjE1TzN2WWdLZjAzTwoyZ1BOM3hxdVZkWnZrVndBb1FaSDJUanRtM2JDMG9KdWhlNEhUcDA1ckVvUWw5QzFlU3NWMlk0MnFSOGRDd3NuCjdsaVNmWUFLWndaRlV5a0xzODBWamNRQ2kzSTUxQitOQlRROUdvNEF4Ty9TRlFYNEN1N0FYaDFheVRBRzlzT1YKdHBvPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
  rules:
  - operations: ["CREATE", "UPDATE"]
    apiGroups: [""]
    apiVersions: ["*"]
    resources: ["pods"]
  failurePolicy: Fail
  admissionReviewVersions: ["v1", "v1beta1"]
  sideEffects: None
  # don't run on gmsa-webhook
  namespaceSelector:
    matchExpressions:
      - key: gmsa-webhook
        operator: NotIn
        values: [disabled]

---

apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration
metadata:
  name: gmsa-webhook
webhooks:
- name: admission-webhook.windows-gmsa.sigs.k8s.io
  clientConfig:
    service:
      name: gmsa-webhook
      namespace: gmsa-webhook
      path: "/mutate"
    caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJeU1Ea3lPREUyTkRjek1Wb1hEVE15TURreU5URTJORGN6TVZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTjJRCm1pS1IrdCtBcFVFYkR2STNBRE1CdEVsa1d2ZFhxRjBhVnkxZk5IOVVaZEhJSEJXblNmNjJVS3F4aFNXdGdhWTIKTStNcVE5OWdKdXNReHhUTEFPYUczRHRmeUJDUGxqbmxVNmZtRHhJWCsvaElMRUJtNlBqcmVOM3FDQzZ4dVpFSgpCMDZSMkJ5d0NEV1I4dmx0YmZPWm8vcE5UcTFtVDYxWFdhQkRabFl4Zy8wcHZjUTV0Z3ZtZjd6SThpbUdGTFRZCkFDZnhKVnhqVDR6TUlKOU9SY2tDZmhXTVJ3YXlmWFZ5SUx6QVFld1Z4SW5yRWlhTWsybGdhN1REcDhvQjNjMGIKMlFyS2dBNG9PS1ltcjBHL0NvbmFOc2c0eFh0dkdodDIxUFcwQ3lweEEwWmtPR1VoaEROMnd2TUlWUytCNFgyTApucG9BL3dySlVLa2ExUnEvNjFNQ0F3RUFBYU5aTUZjd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZDajhncGtCRnpPTmtqMVZZNHQ5cDZUSWtOQk1NQlVHQTFVZEVRUU8KTUF5Q0NtdDFZbVZ5Ym1WMFpYTXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBTFdqMFlPd25OWndOb2Jxd3FvRgp5bkVNSjdFK2FYd0dEM0ljdW9FRTFEKzBVRWNFYmpjM1B4M0dEVU5vSnZhVTNYbTJOSktkVWgzaDQrcnFlQTlxCmNUL1QwbDRsSEJCaUZCNlBFZzhValQ1aW9YdUpnRHY2WXJjTStTTlhIbzE5Zm8wM0JET3JaQXVoaTFjRFlpS3oKcTk5Ri9Cam54R0V2S05obkhKM2xROHZuem5mNkEwYm91WGJ3bll1N0ZSRTVFc0VvZVZ5VjE1TzN2WWdLZjAzTwoyZ1BOM3hxdVZkWnZrVndBb1FaSDJUanRtM2JDMG9KdWhlNEhUcDA1ckVvUWw5QzFlU3NWMlk0MnFSOGRDd3NuCjdsaVNmWUFLWndaRlV5a0xzODBWamNRQ2kzSTUxQitOQlRROUdvNEF4Ty9TRlFYNEN1N0FYaDFheVRBRzlzT1YKdHBvPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
  rules:
  - operations: ["CREATE"]
    apiGroups: [""]
    apiVersions: ["*"]
    resources: ["pods"]
  failurePolicy: Fail
  admissionReviewVersions: ["v1", "v1beta1"]
  sideEffects: None
  # don't run on gmsa-webhook
  namespaceSelector:
    matchExpressions:
    - key: gmsa-webhook
      operator: NotIn
      values: [disabled]
